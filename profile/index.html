<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Profile | ConferenceWorks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Scott Davis <scott@thirstyhead.com>">
    <meta name="description" content="">
    <meta name="keywords" content="">

    <link href="/conferenceworks/css/index.css" rel="stylesheet">  

    <style>
      #photo-preview{
        height: 100px;
        background-size: contain;
        border-radius: 50%;
      }
      #test{
      }
    </style>

    <script src="/conferenceworks/components/cw-header/index.js"></script>
    <script src="/conferenceworks/components/cw-footer/index.js"></script>
    <script>
      window.addEventListener('load', init);

      function init(){
        const profileForm = document.querySelector('#profile-form');
        window.addEventListener('submit', handleFormSubmit);
        loadForm();
        enableAutosave('#profile-form');

        const photoField = profileForm.elements['photo'];
        window.addEventListener('change', updatePhotoThumbnail); 
      }

      function loadForm(){
        const profileForm = document.querySelector('#profile-form');
        const fields = profileForm.elements;
        const currentUser = localStorage.getItem('currentUser'); 
        const currentProfile = JSON.parse(localStorage.getItem(currentUser));
        for(let [key, value] of Object.entries(currentProfile)){
          if(fields[key]){
            fields[key].value = value;
          }

          if(key === 'photo-preview'){
            loadPhotoThumbnail(value);
          }
        }
      }

      function save(key, value){
        let currentUser = localStorage.getItem('currentUser');
        let profileJson = JSON.parse(localStorage.getItem(currentUser));
        profileJson[key] = value;
        localStorage.setItem(currentUser, JSON.stringify(profileJson));
      }

      function enableAutosave(formSelector){
        const form = document.querySelector(formSelector);
        const fields = form.elements;
        for(const field of fields){
          switch(field.tagName){
            case 'INPUT':
              window.addEventListener('change', inputAutosave);
          }
        }
      }

      function inputAutosave(event){
        //let currentUser = localStorage.getItem('currentUser');
        //let profileJson = JSON.parse(localStorage.getItem(currentUser));
        let field = event.target;
        let fieldName = event.target.name;
        let fieldValue = event.target.value;

        if(field.checkValidity()){
          if(fieldName === 'email'){
            currentUser = fieldValue;
            localStorage.setItem('currentUser', currentUser);
          }

          if(fieldName === 'photo'){
            fieldName = 'photo-preview';
            fieldValue = imgToString('#photo-preview');
          }

          save(fieldName, fieldValue);
          //profileJson[fieldName] = fieldValue;
          //localStorage.setItem(currentUser, JSON.stringify(profileJson));
        }
      }

      function handleFormSubmit(event){
        event.preventDefault();
        // each field is saved as changes are made, so no submit button is needed.
      }

      function updatePhotoThumbnail(event){
        const profileForm = document.querySelector('#profile-form');
        const photoField = profileForm.elements['photo'];
        const imgFile = photoField.files[0];

        const reader = new FileReader();
        reader.addEventListener('load', function(){
          loadPhotoThumbnail(reader.result);
        }, false);
        reader.readAsDataURL(imgFile);


        /*
        const imgList = photoField.files;
        for(const img of imgList){
          // let photoPreview = document.querySelector('#photo-preview');
          // photoPreview.src = URL.createObjectURL(img);
          console.log(img);
          loadPhotoThumbnail(URL.createObjectURL(img));
          // loadPhotoThumbnail(imgToString('#photo-preview'));
        }
        */
      }

      function loadPhotoThumbnail(src){
          let photoPreview = document.querySelector('#photo-preview');
          photoPreview.src = src; 
      }

      function imgToString(imgSelector){
        const imgElement = document.querySelector(`${imgSelector}`);
        let imgCanvas = document.createElement('canvas');
        imgCanvas.width = imgElement.width;
        imgCanvas.height = imgElement.height;
        let imgContext = imgCanvas.getContext('2d');
        imgContext.drawImage(imgElement, 0, 0, imgElement.width, imgElement.height);
        return imgCanvas.toDataURL('image/png');
      }
    </script>

  </head>

  <body>
    <cw-header></cw-header>

    <nav class="breadcrumbs-nav" aria-labelledby="breadcrumbs">
      <h2 id="breadcrumbs" hidden aria-hidden="false">Breadcrumbs</h2>
      <ol>
        <li><a href="/conferenceworks/">Home</a></li>
        <li>Profile</li>
      </ol>
    </nav>

    <main>
      <h1>Profile</h1>

      <form id="profile-form" name="profile-form">
        <fieldset>
          <legend>Required</legend>

          <p>
            <label for="firstname">First Name</label> 
            <input id="firstname" 
                   name="firstname" 
                   type="text" 
                   placeholder="Jane" 
                   required>
            <span class="field-message">
              <span class="valid">&check;</span>
              <span class="invalid">&cross; Required; Current value not saved</span>
            </span>
          </p>

          <p>
            <label for="lastname">Last Name</label> 
            <input id="lastname" 
                   name="lastname" 
                   type="text" 
                   placeholder="Doe" 
                   required>
            <span class="field-message">
              <span class="valid">&check;</span>
              <span class="invalid">&cross; Required; Current value not saved</span>
            </span>
          </p>

          <p>
            <label for="email">Email</label> 
            <input id="email" 
                   name="email" 
                   type="email" 
                   placeholder="jane.doe@example.com" 
                   required>
            <span class="field-message">
              <span class="valid">&check;</span>
              <span class="invalid">&cross; Required; Valid email; Current value not saved</span>
            </span>
          </p>

          <p>
            <label for="password">Password</label> 
            <input id="password" 
                   name="password" 
                   type="password"
                   minlength="8"
                   required>
            <span class="field-message">
              <span class="valid">&check;</span>
              <span class="invalid">&cross; Required; Must be at least 8 characters; Current value not saved</span>
            </span>
          </p>
        </fieldset>


        <p>&nbsp;</p>



        <fieldset>
          <legend>Optional</legend>
       
          <p>
            <label for="photo">Photo</label>
            <input id="photo"
               name="photo"
               type="file"
               accept="image/gif, image/jpeg, image/png, image/webp">
            <span class="field-message">
              <span class="valid">&check;</span>
              <span class="invalid">&cross; </span>
            </span>
            <img id="photo-preview" src="">
          </p>

        <!--
          <p>
            <label for="biography">Biography</label> 
            <textarea id="biography" 
                  name="biography"
                  rows="4"
                  maxlength="300"
                  placeholder="Tell us about yourself">
            </textarea>  
            <span class="field-message">
              <span class="valid">&check;</span>
              <span class="invalid">&cross; </span>
            </span>
          </p>

       <p>
        <label for="highlight-color">Highlight Color</label> 
        <input id="highlight-color" 
               name="highlight-color" 
               type="color"
               value="#00ff00"> 
        <span class="field-message">
          <span class="valid">&check;</span>
          <span class="invalid">&cross; </span>
        </span>
        </p>

       <p>
        <label for="birthday">Birthday</label> 
        <input id="birthday" 
               name="birthday" 
               type="date"> 
        <span class="field-message">
          <span class="valid">&check;</span>
          <span class="invalid">&cross; </span>
        </span>
        </p>
        -->

        </fieldset>
      </form>


    </main>

    <cw-footer></cw-footer>
  </body>
</html>
